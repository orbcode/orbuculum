#include "stream_win32.h"
#include <stdlib.h>
#include <stdio.h>
#include <Windows.h>

#include "generics.h"


struct Win32FileStream {
    struct Win32Stream base;
};

#define SELF( stream ) ( ( struct Win32FileStream* )( stream ) )

// ====================================================================================================
// ====================================================================================================
// ====================================================================================================
// Private routines
// ====================================================================================================
// ====================================================================================================
// ====================================================================================================

// ====================================================================================================
static HANDLE _win32FileStreamCreate( const char *file )
{
    HANDLE h = CreateFile(
                           file,
                           GENERIC_READ,
                           FILE_SHARE_READ | FILE_SHARE_WRITE,
                           NULL,
                           OPEN_EXISTING,
                           FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,
                           NULL
               );

    return h;
}

// ====================================================================================================
// ====================================================================================================
// ====================================================================================================
// Publicly available routines
// ====================================================================================================
// ====================================================================================================
// ====================================================================================================

// ====================================================================================================
struct Stream *streamCreateFile( const char *file )
{
    struct Win32FileStream *stream = SELF( calloc( 1, sizeof( struct Win32FileStream ) ) );

    if ( stream == NULL ) {
        return NULL;
    }

    if ( !streamWin32Initialize( ( struct Win32Stream * )stream,  _win32FileStreamCreate( file ) ) ) {
        free( stream );
        return NULL;
    }

    return &stream->base.base;
}